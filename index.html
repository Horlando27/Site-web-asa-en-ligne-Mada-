<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ASA EN LIGNE ETO MADA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
  <style>
    /* Style Général sy Consistance */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      padding-top: 70px;
      transition: all 0.3s ease;
    }
    
    body.dark-mode {
      background-color: #121212;
      color: white;
    }
    
    .dark-mode * {
      background-color: #1e1e1e;
      color: white;
    }
    
    .container { 
      max-width: 400px; 
      margin: 40px auto; 
      padding: 30px; 
      background-color: #ffffff; 
      border-radius: 10px; 
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
    }
    
    .hidden { display: none; }
    
    h2 { text-align: center; color: #007bff; }
    
    form input, form button, button { 
      width: 100%; 
      padding: 12px 15px; 
      margin-top: 15px; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      font-size: 16px; 
    }
    
    form button, button { 
      background-color: #007bff; 
      color: #ffffff; 
      border: none; 
      cursor: pointer; 
      transition: background-color 0.3s; 
    }
    
    form button:hover, button:hover { 
      background-color: #0056b3; 
    }
    
    .link { 
      text-align: center; 
      margin-top: 15px; 
    }
    
    .link a { 
      color: #007bff; 
      text-decoration: none; 
    }
    
    .link a:hover { 
      text-decoration: underline; 
    }
    
    /* Section d'accueil - navigation */
    .home-nav-wrapper { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      background-color: #ffffff; 
      border-bottom: 2px solid #007bff; 
      z-index: 1000; 
    }
    
    .home-nav { 
      display: flex; 
      justify-content: space-around; 
      align-items: center; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 10px 0; 
    }
    
    .home-nav button { 
      background: transparent; 
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      padding: 5px 15px; 
      transition: color 0.3s; 
    }
    
    .home-nav button:hover, .home-nav button.active { 
      color: #0056b3; 
    }
    
    /* Contenu section d'accueil - items flexibles */
    .home-section { 
      display: none; 
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    .home-section.active { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 20px; 
    }
    
    .section-item { 
      background-color: #ffffff; 
      padding: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      max-width: 300px; 
      flex: 1 1 200px; 
      text-align: center; 
    }
    
    /* Page Inscription sy Connexion */
    #register, #login, #payment, #activation { 
      width: 100%; 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    
    #register .container, #login .container, #payment .container, #activation .container { 
      width: 100%; 
      max-width: 400px; 
    }
    
    #register form, #login form, #payment form, #activation form { 
      display: flex; 
      flex-direction: column; 
    }
    
    #register h2, #login h2, #payment h2, #activation h2 { 
      margin-bottom: 20px; 
    }
    
    /* Page Payment & Activation fampahafantarana */
    #payment p, #activation p { 
      font-size: 15px; 
      color: #555; 
      margin-top: 10px; 
      line-height: 1.5; 
    }
    
    /* Style manokana ho an'ny code activation */
    #activation input[type="text"] { 
      letter-spacing: 2px; 
      text-align: center; 
    }
    
    /* Bouton mode sombre */
    .dark-mode-btn {
      position: fixed;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      z-index: 1000;
      background-color: #f0f0f0;
      color: #333;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    
    .dark-mode-btn:hover {
      background-color: #e0e0e0;
      transform: translateY(-50%) scale(1.1);
    }
    
    .dark-mode-btn.active {
      background-color: #333;
      color: #f0f0f0;
    }
    
    /* Service client */
    .service-client-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background-color: #ffffff;
      border: 2px solid #007bff;
      border-radius: 50%;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }
    
    .service-client-icon img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .service-client-icon:hover {
      transform: scale(1.1);
      background-color: #007bff;
    }
    
    .service-client-icon:hover img {
      filter: brightness(0) invert(1);
    }
    
    /* Styles pour la section d'accueil */
    .home-content {
      position: relative;
      max-width:700px;
      margin:2em auto;
      font-family:"Segoe UI",sans-serif;
      background:#f4f7fa;
      color:#333;
    }
    
    .dark-mode .home-content {
      background:#121212;
      color:#e0e0e0;
    }
    
    .home-content h1 {
      text-align:center;
      color:#2c3e50;
      margin:0;
      padding:1em 0;
    }
    
    #settings-btn {
      position:fixed;
      top:50%;
      right:10px;
      transform:translateY(-50%);
      font-size:2em;
      cursor:pointer;
      color:#007BFF;
      background:rgba(255,255,255,0.9);
      border-radius:50%;
      padding:0.2em;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      z-index:1000;
    }
    
    #settings-btn:hover {
      background:rgba(255,255,255,1);
    }
    
    #settings-modal {
      display:none;
      position:fixed;
      top:50%;
      right:50px;
      transform:translateY(-50%);
      width:260px;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1em;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      z-index:1001;
    }
    
    #settings-modal.show {
      display:block;
    }
    
    #form-section {
      background:#fff;
      padding:1em;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      margin-bottom:2em;
    }
    
    textarea, input {
      width:100%;
      padding:0.6em;
      border:1px solid #ccc;
      border-radius:5px;
      margin:6px 0;
    }
    
    .post {
      background:#fff;
      padding:1em;
      margin-bottom:1.5em;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      clear:both;
    }
    
    .dark-mode .post {
      background:#1e1e1e;
    }
    
    .post-avatar {
      width:40px;
      height:40px;
      border-radius:50%;
      float:left;
      margin-right:10px;
      cursor:pointer;
    }
    
    .reactions {
      margin:1em 0;
    }
    
    .emoji-btn {
      font-size:1.4em;
      margin-right:10px;
      cursor:pointer;
    }
    
    .emoji-btn sub {
      vertical-align:super;
      font-size:0.6em;
      color:#444;
      margin-left:3px;
    }
    
    .delete-btn {
      background:#dc3545;
      display:block;
      margin:8px 0;
    }
    
    .delete-btn:hover {
      background:#c82333;
    }
    
    .comment {
      background:#f6f9fc;
      border-left:4px solid #007BFF;
      margin:8px 0;
      padding:0.5em;
      border-radius:4px;
    }
    
    .dark-mode .comment {
      background:#2a2a2a;
      border-color:#BB86FC;
    }
    
    #settings-modal label {
      display:block;
      margin:8px 0 4px;
    }
    
    /* Bouton WhatsApp */
    .download-btn {
      position: fixed;
      bottom: 15px;
      left: 15px;
      padding: 10px 20px;
      background-color: #25D366;
      color: white;
      text-decoration: none;
      border-radius: 50px;
      font-size: 15px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    
    .download-btn:hover {
      background-color: #128C7E;
      transform: translateY(-2px);
    }
    
    .download-icon {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- Section d'inscription -->
  <div id="registration-section" class="container">
    <h2>Inscription</h2>
    <form onsubmit="event.preventDefault(); registerUser();">
      <input type="text" id="full-name" placeholder="Nom complet" required>
      <input type="email" id="reg-email" placeholder="E-mail" required>
      <input type="password" id="reg-password" placeholder="Mot de passe" required>
      <input type="password" id="reg-confirm-password" placeholder="Confirmer mot de passe" required>
      <button type="submit">S'inscrire</button>
    </form>
    <div class="link">
      Déjà un compte ? <a href="#" onclick="showLoginSection()">Connectez-vous</a>
    </div>
  </div>
  
  <!-- Section de connexion initiale -->
  <div id="login-section" class="container hidden">
    <h2>Connexion</h2>
    <form onsubmit="event.preventDefault(); loginUser();">
      <input type="email" id="login-email" placeholder="E-mail" required>
      <input type="password" id="login-password" placeholder="Mot de passe" required>
      <button type="submit">Se connecter</button>
    </form>
    <div class="link">
      <a href="#" onclick="resetPassword()">Mot de passe oublié ?</a>
    </div>
    <div class="link">
      Pas de compte ? <a href="#" onclick="showRegistrationSection()">S'inscrire</a>
    </div>
  </div>
  
  <!-- Section fampahafantarana fandoavana -->
  <div id="payment-instructions" class="container hidden">
    <h2>Effectuez votre paiement</h2>
    <p>Pour recevoir votre code d'activation, veuillez envoyer <strong>1000 Ar</strong> isambolana amin'ireo laharana manaraka:</p>
    <ul>
      <li>0323911654 [RAVELOMANANTSOA Urmin]</li>
      <li>0384557584 [BEFOTSY Ranjity]</li>
      <li>0333635111 [RANAIVOSON Angelo]</li>
    </ul>
    <button onclick="showPaymentProofForm()">J'ai payé</button>
  </div>
  
  <!-- Formulaire de preuve de paiement -->
  <div id="payment-proof" class="container hidden">
    <h2>Preuve de paiement</h2>
    <input type="text" id="proof-fullname" placeholder="Nom complet" required>
    <input type="text" id="proof-phone" placeholder="Numéro de téléphone utilisé" required>
    <input type="number" id="proof-amount" placeholder="Montant à payer" required>
    <button onclick="submitPaymentProof()">Envoyer</button>
  </div>
  
  <!-- Notification de paiement en attente -->
  <div id="pending-verification" class="container hidden">
    <h2>En attente de vérification</h2>
    <p>Votre demande de paiement est en attente de vérification par l'administration.</p>
  </div>
  
  <!-- Notification d'activation -->
  <div id="activation-notification" class="container hidden">
    <h2>Paiement confirmé</h2>
    <div id="admin-notification" class="hidden">
      <p id="admin-notification-text">Vous avez un message de l'admin.</p>
      <button onclick="viewAdminMessage()">Voir</button>
      <button onclick="dismissAdminMessage()">Fermer</button>
    </div>
    <p id="activation-code-container">Voici votre nouveau code d'activation : <strong id="user-activation-code"></strong></p>
    <button onclick="showFinalActivationForm()">Connectez-vous</button>
  </div>
  
  <!-- Formulaire final d'activation -->
  <div id="final-activation-form" class="container hidden">
    <h2>Connexion - Activation</h2>
    <form onsubmit="event.preventDefault(); finalLogin();">
      <input type="email" id="final-email" placeholder="E-mail" required>
      <input type="password" id="final-password" placeholder="Mot de passe" required>
      <input type="text" id="final-activation-code" placeholder="Code d'activation" required>
      <button type="submit">Entrer</button>
    </form>
  </div>
  
  <!-- Page d'accueil (miseho rehefa activation vita) -->
  <div id="homepage" class="container hidden">
    <!-- Wrapper horizontal nav fixed top -->
    <div class="home-nav-wrapper">
      <div class="home-nav">
        <button onclick="showSection('asaMampiasaVola')">🏘️</button>
        <button onclick="showSection('asaGratuit')">💼</button>
        <button onclick="showSection('formationTrading')">🔳</button>
        <button onclick="showSection('transaction')">💵</button>
      </div>
    </div>
    
    <!-- Contenu isaky ny section -->
    <div id="homepage-content">
      <div id="asaMampiasaVola" class="home-section active">
        <button id="darkModeToggle" class="dark-mode-btn">🌙</button>
        
        <!-- Section Profil, Publication, Reactions & Private Chat -->
        <div class="home-content">
          <h1>Asa en Ligne</h1>
          <i id="settings-btn" class="fa-solid fa-cog" title="Paramètres"></i>
          
          <div id="settings-modal">
            <h3>Paramètres</h3>
            <section>
              <h4>1. Ajouter votre information</h4>
              <label for="profile-photo-input">Photo de profil:</label>
              <input type="file" id="profile-photo-input" accept="image/*">
              <label for="info-name">Nom:</label>
              <input type="text" id="info-name" placeholder="Votre nom">
              <label for="info-email">Email:</label>
              <input type="email" id="info-email" placeholder="Votre email">
              <label for="info-phone">Téléphone:</label>
              <input type="tel" id="info-phone" placeholder="Votre numéro">
              <button id="save-info-btn">Enregistrer</button>
            </section>
            <hr>
            <section>
              <h4>2. Mode sombre</h4>
              <label for="dark-toggle">Activer le mode sombre:</label>
              <input type="checkbox" id="dark-toggle">
            </section>
            <hr>
            <section>
              <h4>3. Partager</h4>
              <button id="share-btn">Partager le lien</button>
            </section>
          </div>
          
          <section id="form-section">
            <div id="auth-status"></div>
            <textarea id="description" rows="3" placeholder="Ahoana ny hevitrao?…"></textarea>
            <input type="url" id="fb-link" placeholder="Lien Facebook…">
            <button onclick="postData()">Alefa</button>
          </section>
          <hr>
          <div id="posts"></div>
        </div>
        
        <!-- Bouton WhatsApp -->
        <a href="https://chat.whatsapp.com/LhLJuNd3pX2JOE2hDGkFML?mode=ac_c" target="_blank" class="download-btn">
          <span class="download-icon">📥</span>Télécharger Apk
        </a>
        
        <div class="section-item">
          <h3>Asa Premium 1</h3>
          <p>Opportunités professionnelles avec revenus garantis</p>
        </div>
        
        <div class="section-item">
          <h3>Asa Premium 2</h3>
          <p>Collaborations exclusives pour membres actifs</p>
        </div>
      </div>
      
      <div id="asaGratuit" class="home-section">
        <div class="section-item">
          <h3>Asa Gratuit 1</h3>
          <p>Opportunités sans investissement initial</p>
        </div>
        
        <div class="section-item">
          <h3>Asa Gratuit 2</h3>
          <p>Missions accessibles à tous les membres</p>
        </div>
      </div>
      
      <div id="formationTrading" class="home-section">
        <div class="section-item">
          <h3>Formation Trading 1</h3>
          <p>Introduction au trading en ligne</p>
        </div>
        
        <div class="section-item">
          <h3>Formation Trading 2</h3>
          <p>Stratégies avancées pour traders</p>
        </div>
      </div>
      
      <div id="transaction" class="home-section">
        <div class="section-item">
          <h3>Transaction</h3>
          <a href="https://demande-du-retrait.vercel.app/" target="_blank">
            <button>RETRAIT D'ARGENT</button>
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Service client -->
  <a href="https://service-client-asa-en-ligne-site-we.vercel.app/" class="service-client-icon" target="_blank" title="Service Client">
    <img src="https://cdn-icons-png.flaticon.com/512/1077/1077012.png" alt="Service Client" />
  </a>
  
  <!-- Firebase + App JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      sendPasswordResetEmail, 
      onAuthStateChanged, 
      updateProfile 
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      getDoc, 
      updateDoc, 
      addDoc, 
      collection, 
      deleteDoc, 
      serverTimestamp, 
      query, 
      orderBy, 
      onSnapshot, 
      getDocs, 
      increment 
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK4HqGSjYRT2jFNhAvniSWIzhDvEb2qAQ",
      authDomain: "asa-en-ligne.firebaseapp.com",
      projectId: "asa-en-ligne",
      storageBucket: "asa-en-ligne.appspot.com",
      messagingSenderId: "58359363245",
      appId: "1:58359363245:web:ca5969776ce9cd86aef824",
      measurementId: "G-MRVHVWPV71"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Global variable ho an'ny hafatra admin
    let storedAdminMessage = "";
    let currentUser = null;
    
    // ----- Initialisation -----
    document.addEventListener('DOMContentLoaded', () => {
      // Mode sombre
      const theme = localStorage.getItem('theme') || 'light';
      document.body.classList.toggle('dark-mode', theme === 'dark');
      document.getElementById('dark-toggle').checked = theme === 'dark';
      
      // Écouteurs d'événements
      document.getElementById('settings-btn').addEventListener('click', toggleSettings);
      document.getElementById('save-info-btn').addEventListener('click', saveUserInfo);
      document.getElementById('dark-toggle').addEventListener('change', toggleDarkMode);
      document.getElementById('share-btn').addEventListener('click', shareLink);
      
      // Bouton mode sombre
      const toggleButton = document.getElementById('darkModeToggle');
      toggleButton.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
      });
      
      // État d'authentification
      onAuthStateChanged(auth, user => {
        currentUser = user;
        if (document.getElementById('auth-status')) {
          document.getElementById('auth-status').textContent = user 
            ? `Miarahaba, ${user.displayName || user.email}` 
            : '… mampiasa authentication …';
        }
      });
      
      // Charger les publications
      if (document.getElementById('posts')) {
        loadPosts();
      }
    });
    
     // ----- Fonctions utilitaires -----
    function toggleSettings() {
      document.getElementById('settings-modal').classList.toggle('show');
    }
    
    function toggleDarkMode(e) {
      document.body.classList.toggle('dark-mode', e.target.checked);
      localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
    }
    
    function shareLink() {
      const shareData = { title: document.title, url: location.href };
      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        prompt('Copiez ce lien pour partager:', location.href);
      }
    }
    
    async function saveUserInfo() {
      const file = document.getElementById('profile-photo-input').files[0];
      if (file && currentUser) {
        const reader = new FileReader();
        reader.onload = async e => {
          const dataURL = e.target.result;
          localStorage.setItem('profilePhoto', dataURL);
          await updateProfile(currentUser, { photoURL: dataURL });
          renderProfileIcon();
        };
        reader.readAsDataURL(file);
      }
      
      const name = document.getElementById('info-name').value;
      const email = document.getElementById('info-email').value;
      const phone = document.getElementById('info-phone').value;
      
      localStorage.setItem('infoName', name);
      localStorage.setItem('infoEmail', email);
      localStorage.setItem('infoPhone', phone);
      
      if (currentUser) {
        await setDoc(doc(db, 'users', currentUser.uid), { 
          name, 
          email, 
          phone, 
          updatedAt: serverTimestamp() 
        }, { merge: true });
      }
      
      alert('Information enregistrée');
    }
    
    function renderProfileIcon() {
      const dataURL = localStorage.getItem('profilePhoto');
      if (dataURL && document.getElementById('profile-icon')) {
        document.getElementById('profile-icon').src = dataURL;
      }
    }
    
    // ----- Gestion des publications -----
    async function loadPosts() {
      onSnapshot(query(collection(db, 'publications'), orderBy('createdAt', 'desc')), async snapshot => {
        const out = document.getElementById('posts');
        if (!out) return;
        
        out.innerHTML = '';
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const id = docSnap.id;
          const when = data.createdAt?.toDate().toLocaleString() || '';
          
          const avatarURL = data.author === currentUser?.uid && localStorage.getItem('profilePhoto') 
            ? localStorage.getItem('profilePhoto') 
            : 'https://via.placeholder.com/40';
          
          const avatar = `<img id='profile-icon' class='post-avatar' src='${avatarURL}' onclick="showUserInfo('${data.author}')" title='Voir profil'/>`;
          
          const emojis = ['👍','❤️','😂','😮','😢'];
          const reactHtml = emojis.map(e => {
            const count = data.reactions?.[e] || 0;
            return `<span class='emoji-btn' onclick="reactPost('${id}','${e}')">${e}<sub>${count}</sub></span>`;
          }).join(' ');
          
          const cmSnap = await getDocs(query(collection(db, 'publications', id, 'comments'), orderBy('createdAt','asc')));
          let commentsHtml = '';
          
          cmSnap.forEach(c => {
            const cd = c.data();
            const tm = cd.createdAt?.toDate().toLocaleString() || '';
            commentsHtml += `
              <div class='comment'>
                <strong>${cd.authorName}</strong><small>${tm}</small>
                <p>${cd.text}</p>
              </div>
            `;
          });
          
          const delBtn = currentUser?.uid === data.author
            ? `<button class='delete-btn' onclick="deletePost('${id}','${data.author}')">🗑️ Supprimer</button>`
            : '';
          
          out.innerHTML += `
            <div class='post'>
              ${avatar}
              <p><strong>${data.authorName}</strong> <em>${when}</em></p>
              <p>${data.description}</p>
              <p><a href='${data.fbLink}' target='_blank'>Facebook Link</a></p>
              <div class='reactions'>${reactHtml}</div>
              ${delBtn}
              <div class='comments'>
                ${commentsHtml}
                <textarea id='comment-input-${id}' placeholder='Soraty hevitra…'></textarea>
                <button onclick="commentOnPost('${id}')">↩️</button>
              </div>
            </div>
          `;
        }
      });
    }
    
    // ----- Fonctions de publication -----
    window.postData = async () => {
      const desc = document.getElementById('description').value.trim();
      const fbLink = document.getElementById('fb-link').value.trim();
      
      if (!currentUser || !desc || !fbLink) {
        return alert("Fenoy tsara an'ireo saha rehetra!");
      }
      
      await addDoc(collection(db, 'publications'), {
        author: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email,
        description: desc,
        fbLink,
        reactions: {},
        createdAt: serverTimestamp()
      });
      
      document.getElementById('description').value = '';
      document.getElementById('fb-link').value = '';
    };
    
    window.reactPost = async (postId, emoji) => {
      await updateDoc(doc(db, 'publications', postId), {
        [`reactions.${emoji}`]: increment(1)
      });
    };
    
    window.commentOnPost = async postId => {
      const ta = document.getElementById(`comment-input-${postId}`);
      const text = ta.value.trim();
      
      if (!currentUser || !text) return;
      
      await addDoc(collection(db, 'publications', postId, 'comments'), {
        author: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email,
        text,
        createdAt: serverTimestamp()
      });
      
      ta.value = '';
    };
    
    window.deletePost = async (postId, authorId) => {
      if (currentUser?.uid !== authorId) return;
      if (!confirm("Hofafana ve ity publication ity?")) return;
      await deleteDoc(doc(db, 'publications', postId));
    };
    
    // ----- Affichage des sections -----
    window.showRegistrationSection = function() {
      hideAllSections();
      document.getElementById("registration-section").classList.remove("hidden");
    };
    
    window.showLoginSection = function() {
      hideAllSections();
      document.getElementById("login-section").classList.remove("hidden");
    };
    
    window.showPaymentProofForm = function() {
      hideAllSections();
      document.getElementById("payment-proof").classList.remove("hidden");
    };
    
    window.showFinalActivationForm = function() {
      hideAllSections();
      document.getElementById("final-activation-form").classList.remove("hidden");
    };
    
    function hideAllSections() {
      const sections = [
        "registration-section", "login-section", "payment-instructions", 
        "payment-proof", "pending-verification", "activation-notification", 
        "final-activation-form", "homepage"
      ];
      
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });
    }
    
    // ----- Inscription -----
    window.registerUser = async function() {
      const fullName = document.getElementById("full-name").value.trim();
      const email = document.getElementById("reg-email").value.trim();
      const password = document.getElementById("reg-password").value;
      const confirmPassword = document.getElementById("reg-confirm-password").value;
      
      if (password !== confirmPassword) {
        alert("Les mots de passe ne correspondent pas.");
        return;
      }
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Enregistrer l'utilisateur sans code d'activation
        await setDoc(doc(db, "users", user.uid), {
          fullName: fullName,
          email: email,
          paymentStatus: "not_paid",
          createdAt: new Date()
        });
        
        alert("Inscription réussie. Veuillez effectuer le paiement pour recevoir un code d'activation.");
        showLoginSection();
      } catch (error) {
        alert("Erreur : " + error.message);
      }
    };
    
    // ----- Connexion initiale -----
    window.loginUser = async function() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userDoc = await getDoc(doc(db, "users", user.uid));
        
        if (userDoc.exists()) {
          const userData = userDoc.data();
          hideAllSections();
          
          if (userData.paymentStatus === "confirmed") {
            document.getElementById("activation-notification").classList.remove("hidden");
            document.getElementById("user-activation-code").textContent = userData.activationCode;
            
            if (userData.adminMessage) {
              storedAdminMessage = userData.adminMessage;
              document.getElementById("admin-notification-text").textContent = "Vous avez un message de l'admin.";
              document.getElementById("admin-notification").classList.remove("hidden");
            }
          } else if (userData.paymentStatus === "pending") {
            document.getElementById("pending-verification").classList.remove("hidden");
          } else {
            document.getElementById("payment-instructions").classList.remove("hidden");
          }
        } else {
          alert("Aucune donnée utilisateur trouvée.");
        }
      } catch (error) {
        alert("Erreur : " + error.message);
      }
    };
    
    window.resetPassword = async function() {
      const email = document.getElementById("login-email").value.trim();
      if (!email) {
        alert("Veuillez entrer votre adresse e-mail.");
        return;
      }
      
      try {
        await sendPasswordResetEmail(auth, email);
        alert("Email de réinitialisation envoyé !");
      } catch (error) {
        alert("Erreur : " + error.message);
      }
    };
    
    // ----- Preuve de paiement -----
    window.submitPaymentProof = async function() {
      const proofFullName = document.getElementById("proof-fullname").value.trim();
      const proofPhone = document.getElementById("proof-phone").value.trim();
      const proofAmount = document.getElementById("proof-amount").value.trim();
      
      if (!proofFullName || !proofPhone || !proofAmount) {
        alert("Veuillez remplir tous les champs.");
        return;
      }
      
      try {
        const userId = auth.currentUser.uid;
        
        await addDoc(collection(db, "paymentRequests"), {
          userId,
          fullName: proofFullName,
          phone: proofPhone,
          amount: proofAmount,
          timestamp: new Date().toISOString(),
          status: "pending"
        });
        
        await updateDoc(doc(db, "users", userId), {
          paymentStatus: "pending"
        });
        
        alert("Votre demande de paiement a été envoyée et est en attente de vérification.");
        hideAllSections();
        document.getElementById("pending-verification").classList.remove("hidden");
      } catch (error) {
        alert("Erreur lors de l'envoi de la preuve : " + error.message);
      }
    };
    
    // ----- Notification admin -----
    window.viewAdminMessage = function() {
      alert("Message de l'admin : " + storedAdminMessage);
      document.getElementById("admin-notification").classList.add("hidden");
    };
    
    window.dismissAdminMessage = function() {
      document.getElementById("admin-notification").classList.add("hidden");
    };
    
    // ----- Activation finale -----
    window.finalLogin = async function() {
      const email = document.getElementById("final-email").value.trim();
      const password = document.getElementById("final-password").value;
      const activationCodeInput = document.getElementById("final-activation-code").value.trim();
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userDoc = await getDoc(doc(db, "users", user.uid));
        
        if (userDoc.exists()) {
          const userData = userDoc.data();
          
          if (userData.activationCode === activationCodeInput) {
            alert("Connexion réussie !");
            hideAllSections();
            document.getElementById("homepage").classList.remove("hidden");
          } else {
            alert("Code d'activation incorrect.");
          }
        } else {
          alert("Aucune donnée utilisateur trouvée.");
        }
      } catch (error) {
        alert("Erreur : " + error.message);
      }
    };
    
    // ----- Navigation ao amin'ny page d'accueil -----
    window.showSection = function(sectionId) {
      const sections = document.querySelectorAll(".home-section");
      sections.forEach(section => {
        section.classList.toggle("active", section.id === sectionId);
      });
    };
    
    // ----- Affichage des infos utilisateur -----
    window.showUserInfo = async function(uid) {
      try {
        const userDoc = await getDoc(doc(db, 'users', uid));
        if (userDoc.exists()) {
          const d = userDoc.data();
          alert(`Nom: ${d.name || 'Non spécifié'}\nEmail: ${d.email || 'Non spécifié'}\nPhone: ${d.phone || 'Non spécifié'}`);
        } else {
          alert('Tsy misy fampahalalana ho an\'ity mpampiasa ity.');
        }
      } catch (error) {
        console.error("Erreur lors de la récupération des informations utilisateur:", error);
        alert("Une erreur s'est produite lors de la récupération des informations.");
      }
    };
  </script>
</body>
</html>
    
